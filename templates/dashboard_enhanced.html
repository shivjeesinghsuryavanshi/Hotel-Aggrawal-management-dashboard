{% extends "base.html" %}

{% block title %}Dashboard - Hotel Management System{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Cache busting for emoji icons -->
    <style>
        .action-btn-emoji {
            font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', 'Segoe UI', system-ui, sans-serif !important;
            font-size: 16px !important;
            line-height: 1 !important;
        }
        .preview-btn-text:after { content: " View"; }
        .generate-btn-text:after { content: " Generate"; }
        .disabled-btn-text:after { content: " Disabled"; }
    </style>
    
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h2>üè® Hotel Management Dashboard</h2>
        <p class="welcome-message">Welcome back! Here's your hotel status overview.</p>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-icon">üè®</div>
            <div class="stat-info">
                <h3>{{ stats.total_rooms }}</h3>
                <p>Total Rooms</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-info">
                <h3>{{ stats.checked_in_today }}</h3>
                <p>Checked In Today</p>
            </div>
        </div>
        <div class="stat-card available">
            <div class="stat-icon">üîì</div>
            <div class="stat-info">
                <h3>{{ stats.available_today }}</h3>
                <p>Available Rooms</p>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="quick-actions">
        <h3>üöÄ Quick Actions</h3>
        <div class="action-buttons">
            <a href="{{ url_for('checkin') }}" class="btn btn-primary">
                ‚ûï New Check-In
            </a>
            <a href="{{ url_for('calendar_view') }}" class="btn btn-secondary">
                üìÖ View Calendar
            </a>
            <a href="{{ url_for('export_excel') }}" class="btn btn-success">
                üìä Export Excel Report
            </a>
        </div>
    </div>
    
    <!-- Recent Check-ins Table -->
    <div class="recent-checkins">
        <h3>üë• Recent Check-ins</h3>
        {% if stats.recent_checkins %}
        <div class="table-container">
            <table class="checkin-table">
                <thead>
                    <tr>
                        <th>Guest Name</th>
                        <th>Mobile</th>
                        <th>Aadhar</th>
                        <th>Amount Paid</th>
                        <th>Remaining</th>
                        <th>Check-In Status</th>
                        <th>Room No.</th>
                        <th>Date</th>
                        <th>Receipt</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for checkin in stats.recent_checkins %}
                    <tr>
                        <td>{{ checkin[0] }}</td>
                        <td>{{ checkin[1] }}</td>
                        <td>{{ checkin[2] }}</td>
                        <td>‚Çπ{{ "%.2f"|format(checkin[3]) }}</td>
                        <td>‚Çπ{{ "%.2f"|format(checkin[4]) }}</td>
                        <td>
                            <span class="status-badge {{ 'completed' if checkin[5] else 'pending' }}">
                                {{ 'Completed' if checkin[5] else 'Pending' }}
                            </span>
                        </td>
                        <td class="room-number">{{ checkin[6] }}</td>
                        <td>{{ checkin[7] }}</td>
                        <td>
                            <span class="receipt-status {{ 'issued' if checkin[8] else 'not-issued' }}">
                                {{ 'Issued' if checkin[8] else 'Not Issued' }}
                            </span>
                        </td>
                        <td class="action-buttons">
                            <!-- ENHANCED PREVIEW LOGIC WITH FALLBACK TEXT -->
                            {% if checkin[5] == 1 %}
                                <!-- COMPLETED CHECK-INS -->
                                {% if checkin[8] == 1 and checkin[10] %}
                                    <!-- HAS RECEIPT - SHOW PREVIEW EYE -->
                                    <a href="{{ url_for('preview_receipt', tourist_id=checkin[9]) }}" 
                                       class="btn btn-sm btn-info preview-btn action-btn-emoji" 
                                       title="Preview Receipt">
                                        <span class="preview-btn-text">&#128065;</span>
                                    </a>
                                {% else %}
                                    <!-- NO RECEIPT - SHOW GENERATE BUTTON -->
                                    <form method="POST" action="{{ url_for('generate_receipt', tourist_id=checkin[9]) }}" 
                                          style="display: inline;">
                                        <button type="submit" class="btn btn-sm btn-primary generate-btn action-btn-emoji" 
                                                title="Generate Receipt">
                                            <span class="generate-btn-text">&#128221;</span>
                                        </button>
                                    </form>
                                {% endif %}
                            {% else %}
                                <!-- PENDING CHECK-INS - DISABLED -->
                                <span class="btn btn-sm btn-secondary disabled-btn action-btn-emoji" 
                                      title="Complete check-in first">
                                    <span class="disabled-btn-text">&#128683;</span>
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="no-data">
            <p>No check-ins recorded yet.</p>
            <a href="{{ url_for('checkin') }}" class="btn btn-primary">Add First Check-In</a>
        </div>
        {% endif %}
    </div>
    
    <!-- Room Status Visual -->
    <div class="room-status-section">
        <h3>üè† Room Status Overview</h3>
        <div class="room-grid">
            <!-- Room grid will be populated by JavaScript -->
        </div>
    </div>
    
    <!-- Debug Information -->
    <div class="debug-info" style="margin-top: 20px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; font-size: 12px;">
        <p><strong>Debug Info:</strong></p>
        <p>Total guests: {{ stats.recent_checkins|length }}</p>
        <p>Expected preview buttons: 
            {% set preview_count = [] %}
            {% for checkin in stats.recent_checkins %}
                {% if checkin[5] == 1 and checkin[8] == 1 and checkin[10] %}
                    {% set _ = preview_count.append(1) %}
                {% endif %}
            {% endfor %}
            {{ preview_count|length }}
        </p>
        <p>Cache buster: {{ moment().format('YYYY-MM-DD HH:mm:ss') if moment else 'N/A' }}</p>
    </div>
</div>

<script>
// Auto-refresh dashboard every 30 seconds
setInterval(function() {
    location.reload();
}, 30000);

// Room grid visualization
document.addEventListener('DOMContentLoaded', function() {
    const roomGrid = document.querySelector('.room-grid');
    if (roomGrid) {
        // Create room grid (157 rooms)
        for (let i = 1; i <= 157; i++) {
            const roomDiv = document.createElement('div');
            roomDiv.className = 'room-item available'; // Default to available
            roomDiv.textContent = i;
            roomDiv.title = `Room ${i} - Available`;
            roomGrid.appendChild(roomDiv);
        }
    }
    
    // Debug emoji rendering
    console.log('Dashboard loaded with enhanced emoji support');
    console.log('Preview buttons should show üëÅÔ∏è for guests with receipts');
    
    // Test emoji rendering
    const testEmojis = ['&#128065;', '&#128221;', '&#128683;'];
    testEmojis.forEach(emoji => {
        const span = document.createElement('span');
        span.innerHTML = emoji;
        span.style.display = 'none';
        document.body.appendChild(span);
        console.log(`Emoji ${emoji} rendered as: ${span.textContent}`);
    });
});
</script>
{% endblock %}
